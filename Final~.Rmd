---
title: "Final_"
author: "XunSun"
date: "`r Sys.Date()`"
output: html_document
---

# Setup and Libraries
```{r library}
library(tidyverse)
library(janitor)
library(ggplot2)
library(GGally)
library(dplyr)
library(gridExtra)
library(survival)
library(car)
library(PerformanceAnalytics)
library(glmnet)
library(caret)
library(pROC)
library(MASS)
library(writexl)
library(corrplot)
library(survivalROC)
set.seed(1)
```

```{r}
# Load the dataset
project_2_data <- read_csv("Project_2_data.csv", na = c("NA", "", ".")) |>
  janitor::clean_names() |>
  mutate(
    status = ifelse(status == "Dead", 1, 0),
    t_stage = case_when(t_stage == "T1" ~ 1, t_stage == "T2" ~ 2, t_stage == "T3" ~ 3, t_stage == "T4" ~ 4),
    n_stage = case_when(n_stage == "N1" ~ 1, n_stage == "N2" ~ 2, n_stage == "N3" ~ 3),
    differentiate = case_when(
      differentiate == "Well differentiated" ~ 1,
      differentiate == "Moderately differentiated" ~ 2,
      differentiate == "Poorly differentiated" ~ 3,
      differentiate == "Undifferentiated" ~ 4
    ),
    grade = as.numeric(as.character(grade)),
    a_stage_regional = ifelse(a_stage == "Regional", 1, 0),
    estrogen_status = ifelse(estrogen_status == "Positive", 1, 0),
    progesterone_status = ifelse(progesterone_status == "Positive", 1, 0)
  ) |>
  select(-a_stage) |>
  na.omit()

# Check missingness and descriptive statistics
summary(project_2_data)

```

```{r}
# Log transformations
project_2_data <- project_2_data |>
  mutate(
    log_tumor_size = log(tumor_size + 1),
    log_regional_node_examined = log(regional_node_examined + 1)
  )

# Visualize transformations
ggplot(project_2_data, aes(x = log_tumor_size)) +
  geom_histogram(fill = "blue", color = "black") +
  labs(title = "Log-Transformed Tumor Size")

ggplot(project_2_data, aes(x = log_regional_node_examined)) +
  geom_histogram(fill = "green", color = "black") +
  labs(title = "Log-Transformed Regional Nodes Examined")

```

```{r}
# Correlation matrix and multicollinearity
cor_matrix <- cor(project_2_data[, sapply(project_2_data, is.numeric)], use = "complete.obs")
corrplot(cor_matrix, method = "circle")

# Drop high VIF variables
project_2_data <- project_2_data |>
  select(-c(t_stage, n_stage, reginol_node_positive, differentiate))


```

```{r}
# Balance the dataset
dead <- project_2_data |> filter(status == 1)
alive <- project_2_data |> filter(status == 0) |> sample_n(nrow(dead))
balance_df <- bind_rows(dead, alive)

# Visualize balance
ggplot(balance_df, aes(x = status)) + geom_bar() + labs(title = "Balanced Dataset")

```
logistic without interaction
```{r}
# Full logistic regression model
logit_model <- glm(status ~ ., data = balance_df, family = binomial())
summary(logit_model)

# Variable selection: AIC and BIC
aic_model <- stepAIC(logit_model, trace = FALSE)
bic_model <- stepAIC(logit_model, k = log(nrow(balance_df)), trace = FALSE)

# Model performance
evaluate_model <- function(model, data, model_name) {
  predictions <- predict(model, type = "response")
  data$predicted_classes <- ifelse(predictions > 0.5, 1, 0)
  conf_matrix <- confusionMatrix(factor(data$predicted_classes), factor(data$status))
  roc_curve <- roc(data$status, predictions)
  list(
    LogLikelihood = logLik(model),
    ConfusionMatrix = conf_matrix,
    AUC = auc(roc_curve)
  )
}

logit_results_aic <- evaluate_model(aic_model, balance_df, "AIC Model")
logit_results_bic <- evaluate_model(bic_model, balance_df, "BIC Model")

```
interation logistic!!!!
```{r}

library(fastDummies)

# Create dummy variables for categorical variables
balance_data_dummies <- dummy_cols(
  balance_data,
  select_columns = c("race", "marital_status", "x6th_stage", "a_stage"),
  remove_first_dummy = TRUE,  # Avoid multicollinearity by removing the first dummy
  remove_selected_columns = TRUE  # Remove original columns
)

# View the updated dataset
head(balance_data_dummies)

# Generate all two-way interactions
formula_with_interactions <- status ~ 
  (age + grade + tumor_size + estrogen_status + progesterone_status + 
   regional_node_examined + reginol_node_positive)^2 + 
   marital_status_Single + marital_status_Widowed + marital_status_Separated + 
   x6th_stage_IIB + x6th_stage_IIIA + x6th_stage_IIIB + x6th_stage_IIIC + 
   a_stage_regional

# Fit the logistic regression model with interaction terms
interaction_model <- glm(formula_with_interactions, data = balance_data_dummies, family = binomial())

# Summary of the model
summary(interaction_model)

```
Model Selection with Stepwise Approaches
```{r}
# Perform Stepwise Selection (AIC)
aic_forward_model <- stepAIC(interaction_model, direction = "forward", trace = FALSE)
aic_backward_model <- stepAIC(interaction_model, direction = "backward", trace = FALSE)
aic_both_model <- stepAIC(interaction_model, direction = "both", trace = FALSE)

# Perform Stepwise Selection (BIC)
bic_forward_model <- stepAIC(interaction_model, direction = "forward", trace = FALSE, k = log(nrow(balance_data)))
bic_backward_model <- stepAIC(interaction_model, direction = "backward", trace = FALSE, k = log(nrow(balance_data)))
bic_both_model <- stepAIC(interaction_model, direction = "both", trace = FALSE, k = log(nrow(balance_data)))

```
Coefficient Extraction and Export
```{r}
# Extract coefficients from models
extract_coefficients <- function(model, model_name) {
  coef <- as.data.frame(summary(model)$coefficients)
  coef$Term <- rownames(coef)
  coef$Model <- model_name
  return(coef)
}

# Combine coefficients from AIC and BIC models
aic_combined <- merge(
  extract_coefficients(aic_forward_model, "AIC Forward"),
  extract_coefficients(aic_backward_model, "AIC Backward"),
  by = "Term", all = TRUE, suffixes = c("_AIC_Forward", "_AIC_Backward")
)

aic_combined <- merge(
  aic_combined,
  extract_coefficients(aic_both_model, "AIC Both"),
  by = "Term", all = TRUE
)

bic_combined <- merge(
  extract_coefficients(bic_forward_model, "BIC Forward"),
  extract_coefficients(bic_backward_model, "BIC Backward"),
  by = "Term", all = TRUE, suffixes = c("_BIC_Forward", "_BIC_Backward")
)

bic_combined <- merge(
  bic_combined,
  extract_coefficients(bic_both_model, "BIC Both"),
  by = "Term", all = TRUE
)

# Combine AIC and BIC results into one table
comparison_table <- merge(aic_combined, bic_combined, by = "Term", all = TRUE)

# Replace NA with 0 for consistency
comparison_table[is.na(comparison_table)] <- 0

# Export the table
write_xlsx(comparison_table, "aic_bic_stepwise_comparison.xlsx")
cat("Comparison table exported to 'aic_bic_stepwise_comparison.xlsx'")

```
Model Evaluation
```{r}
evaluate_model <- function(model, data, model_name) {
  predictions <- predict(model, type = "response")
  data$predicted_classes <- ifelse(predictions > 0.5, 1, 0)
  conf_matrix <- confusionMatrix(factor(data$predicted_classes), factor(data$status))
  roc_curve <- roc(data$status, predictions)
  
  list(
    LogLikelihood = logLik(model),
    ConfusionMatrix = conf_matrix,
    AUC = auc(roc_curve)
  )
}

# Evaluate AIC and BIC Models
aic_forward_results <- evaluate_model(aic_forward_model, balance_data, "AIC Forward")
aic_backward_results <- evaluate_model(aic_backward_model, balance_data, "AIC Backward")
aic_both_results <- evaluate_model(aic_both_model, balance_data, "AIC Stepwise")
bic_forward_results <- evaluate_model(bic_forward_model, balance_data, "BIC Forward")
bic_backward_results <- evaluate_model(bic_backward_model, balance_data, "BIC Backward")
bic_both_results <- evaluate_model(bic_both_model, balance_data, "BIC Stepwise")

# Plot ROC Curves
plot(aic_forward_results$roc_curve, col = "blue", lwd = 2, main = "ROC Curves for All Models")
lines(aic_backward_results$roc_curve, col = "green", lwd = 2)
lines(aic_both_results$roc_curve, col = "cyan", lwd = 2)
lines(bic_forward_results$roc_curve, col = "red", lwd = 2)
lines(bic_backward_results$roc_curve, col = "orange", lwd = 2)
lines(bic_both_results$roc_curve, col = "purple", lwd = 2)

legend("bottomright", 
       legend = c("AIC Forward", "AIC Backward", "AIC Both", "BIC Forward", "BIC Backward", "BIC Both"),
       col = c("blue", "green", "cyan", "red", "orange", "purple"), 
       lwd = 2)

```
Fairness Evaluation
```{r}
evaluate_performance <- function(data, model, group_name) {
  subset_data <- data |> filter(race %in% group_name)
  predictions <- predict(model, newdata = subset_data, type = "response")
  predicted_classes <- ifelse(predictions > 0.5, 1, 0)
  conf_matrix <- confusionMatrix(factor(predicted_classes), factor(subset_data$status))
  roc_curve <- roc(subset_data$status, predictions)
  
  list(
    ConfusionMatrix = conf_matrix,
    AUC = auc(roc_curve)
  )
}

# Evaluate performance for different racial groups
white_results <- evaluate_performance(balance_data, bic_backward_model, "White")
black_results <- evaluate_performance(balance_data, bic_backward_model, "Black")
black_other_results <- evaluate_performance(balance_data, bic_backward_model, c("Black", "Other"))

list(
  White = white_results,
  Black = black_results,
  Black_Other = black_other_results
)

```

Survival Analysis Models
```{r}
# Cox proportional hazards model
cox_model <- coxph(Surv(survival_months, status) ~ age + grade + log_tumor_size + log_regional_node_examined + x6th_stage + a_stage_regional, data = project_2_data)
summary(cox_model)

# Stepwise variable selection (AIC and BIC)
cox_aic <- step(cox_model, direction = "both", trace = FALSE)
cox_bic <- stepAIC(cox_model, k = log(nrow(project_2_data)), trace = FALSE)

# Time-dependent AUC
compute_auc <- function(data, model, time_point) {
  predictions <- predict(model, newdata = data, type = "risk")
  survivalROC(Stime = data$survival_months, status = data$status, marker = predictions, predict.time = time_point, method = "KM")$AUC
}

# Evaluate for different time points
time_points <- c(25, 50, 75)
auc_results <- sapply(time_points, function(tp) compute_auc(project_2_data, cox_model, tp))
auc_results

```

Comparison and Fairness Check
```{r}
# Evaluate AUC across race groups
evaluate_auc_by_race <- function(data, model, race_group, time_points) {
  subset_data <- data |> filter(race %in% race_group)
  sapply(time_points, function(tp) compute_auc(subset_data, model, tp))
}

auc_white <- evaluate_auc_by_race(project_2_data, cox_model, "White", time_points)
auc_black <- evaluate_auc_by_race(project_2_data, cox_model, "Black", time_points)
auc_black_other <- evaluate_auc_by_race(project_2_data, cox_model, c("Black", "Other"), time_points)

list(
  White = auc_white,
  Black = auc_black,
  Black_Other = auc_black_other
)

```

